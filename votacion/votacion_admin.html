<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración de Votación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Importa las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales (proporcionadas por el entorno de Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa Firebase
        let app, db, auth;
        let unsubscribeUser;
        let isAuthReady = false;
        let userId;

        window.onload = async function() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Cannot initialize the app.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInWithCustomToken(auth, authToken).catch(async (error) => {
                    if (error.code === 'auth/invalid-custom-token') {
                         await signInAnonymously(auth);
                    } else {
                        console.error('Error signing in with custom token:', error);
                    }
                });

                // Espera a que el estado de autenticación cambie
                const unsub = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('userIdDisplay').textContent = `ID de Usuario: ${userId}`;
                        setupAdmin();
                    } else {
                        isAuthReady = false;
                        userId = null;
                        document.getElementById('userIdDisplay').textContent = 'Sesión no iniciada';
                    }
                    unsub(); // Desuscribe después de la primera autenticación
                });

            } catch (e) {
                console.error("Error during Firebase initialization or sign-in:", e);
            }
        };

        // Configura el panel de administración
        async function setupAdmin() {
            try {
                if (!isAuthReady) {
                    console.log('Authentication is not ready yet.');
                    return;
                }
                const adminCollectionRef = collection(db, `artifacts/${appId}/public/data/admins`);
                const q = query(adminCollectionRef, where("id", "==", userId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    // El usuario no es un administrador
                    document.getElementById('adminPanel').classList.add('hidden');
                    document.getElementById('message').textContent = 'Acceso denegado. No eres un administrador.';
                } else {
                    // El usuario es un administrador
                    document.getElementById('adminPanel').classList.remove('hidden');
                    document.getElementById('message').textContent = '¡Bienvenido, administrador!';
                    setupVoiceCommand();
                }

            } catch (e) {
                console.error("Error checking admin status:", e);
                document.getElementById('message').textContent = 'Ocurrió un error al verificar tu estado de administrador.';
            }
        }

        // Configura el reconocimiento de voz para el conteo de votos
        function setupVoiceCommand() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                document.getElementById('voiceMessage').textContent = 'Lo siento, tu navegador no soporta el reconocimiento de voz.';
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            recognition.interimResults = false;

            document.getElementById('startVoiceBtn').onclick = () => {
                document.getElementById('voiceMessage').textContent = 'Escuchando... Di el nombre de un candidato para votar.';
                recognition.start();
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                document.getElementById('voiceMessage').textContent = `Comando de voz reconocido: "${transcript}"`;
                voteByVoice(transcript);
            };

            recognition.onerror = (event) => {
                document.getElementById('voiceMessage').textContent = `Error en el reconocimiento de voz: ${event.error}`;
                console.error('Speech recognition error:', event.error);
            };

            async function voteByVoice(candidateName) {
                try {
                    const candidatesCollectionRef = collection(db, `artifacts/${appId}/public/data/candidatos`);
                    const q = query(candidatesCollectionRef, where("name", "==", candidateName));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const candidateDoc = querySnapshot.docs[0];
                        const docRef = doc(db, `artifacts/${appId}/public/data/candidatos`, candidateDoc.id);
                        const currentData = candidateDoc.data();
                        const newVoteCount = (currentData.votes || 0) + 1;
                        await updateDoc(docRef, { votes: newVoteCount });
                        document.getElementById('voiceMessage').textContent = `¡Voto registrado para ${candidateName}! Nuevo total: ${newVoteCount}`;
                    } else {
                        document.getElementById('voiceMessage').textContent = `Candidato "${candidateName}" no encontrado.`;
                    }
                } catch (e) {
                    console.error("Error voting by voice:", e);
                    document.getElementById('voiceMessage').textContent = 'Ocurrió un error al registrar el voto.';
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 font-sans">
    <div class="w-full max-w-lg bg-white p-8 rounded-lg shadow-xl text-center">
        <h1 class="text-3xl font-bold text-blue-600 mb-6">Panel de Administración</h1>
        <p id="userIdDisplay" class="text-sm text-gray-500 mb-4"></p>
        <div id="message" class="text-lg font-medium text-gray-700 mb-6">Verificando tu estado de administrador...</div>

        <div id="adminPanel" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Control de Votación</h2>
            
            <button id="startVoiceBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-105 shadow-lg">
                Iniciar Votación por Voz
            </button>

            <p id="voiceMessage" class="mt-4 text-gray-600 italic"></p>
        </div>
    </div>
</body>
</html>