<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Administrador Regional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <!-- Contenedor del formulario de inicio de sesión -->
    <div id="login-form" class="bg-white p-8 rounded-lg shadow-md max-w-md w-full text-center">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Iniciar Sesión</h1>
        <form class="space-y-4" id="admin-login-form">
            <div>
                <input type="email" id="login-email" placeholder="Correo de Administrador General" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <input type="password" id="login-password" placeholder="Contraseña" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                Acceder como Administrador General
            </button>
            <p id="login-message" class="mt-4 text-sm"></p>
        </form>
    </div>

    <!-- Contenedor de la aplicación principal -->
    <div id="app" class="bg-white p-8 rounded-lg shadow-md max-w-md w-full text-center hidden">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Crear Administrador Regional</h1>
        <form id="create-admin-form" class="space-y-4">
            <div>
                <input type="email" id="email" placeholder="Correo electrónico" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <input type="password" id="password" placeholder="Contraseña" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <select id="region-select" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <option value="" disabled selected>Selecciona una región</option>
                    <option value="Arica y Parinacota">Arica y Parinacota</option>
                    <option value="Tarapacá">Tarapacá</option>
                    <option value="Antofagasta">Antofagasta</option>
                    <option value="Atacama">Atacama</option>
                    <option value="Coquimbo">Coquimbo</option>
                    <option value="Valparaíso">Valparaíso</option>
                    <option value="Metropolitana de Santiago">Metropolitana de Santiago</option>
                    <option value="O'Higgins">O'Higgins</option>
                    <option value="Maule">Maule</option>
                    <option value="Ñuble">Ñuble</option>
                    <option value="Biobío">Biobío</option>
                    <option value="Araucanía">Araucanía</option>
                    <option value="Los Ríos">Los Ríos</option>
                    <option value="Los Lagos">Los Lagos</option>
                    <option value="Aysén">Aysén</option>
                    <option value="Magallanes y Antártica Chilena">Magallanes y Antártica Chilena</option>
                </select>
            </div>
            <button type="submit" id="submit-btn"
                class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                Crear Administrador Regional
            </button>
            <p id="message" class="mt-4 text-sm"></p>
        </form>
    </div>

    <!-- Contenedor de acceso denegado -->
    <div id="denied" class="hidden bg-white p-8 rounded-lg shadow-md max-w-sm w-full text-center">
        <h1 class="text-2xl font-bold mb-4 text-red-600">Acceso Denegado</h1>
        <p class="text-gray-600">No tienes permisos para acceder a esta página. Por favor, inicia sesión con una cuenta de Administrador General.</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Aseguramos que el código se ejecute cuando toda la página esté cargada
        document.addEventListener('DOMContentLoaded', () => {

            // Variables inyectadas por el entorno de Canvas
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // Inicializar Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            console.log("Firebase inicializado con éxito.");
            
            // Referencias a los contenedores HTML
            const appContainer = document.getElementById('app');
            const deniedContainer = document.getElementById('denied');
            const loginContainer = document.getElementById('login-form');
            const loginMessageElement = document.getElementById('login-message');
            const messageElement = document.getElementById('message');

            // Función para mostrar mensajes en el formulario de login
            function showLoginMessage(msg, isError = false) {
                loginMessageElement.textContent = msg;
                loginMessageElement.className = `mt-4 text-sm font-semibold ${isError ? 'text-red-600' : 'text-green-600'}`;
            }
            
            const loginForm = document.getElementById('admin-login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault(); // Evita que el formulario recargue la página
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    
                    showLoginMessage('Iniciando sesión...', false);

                    try {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        console.log("Usuario autenticado:", userCredential.user.uid);
                        showLoginMessage('Inicio de sesión exitoso. Redirigiendo...', false);
                        // El onAuthStateChanged se encargará de mostrar el siguiente contenedor.
                    } catch (error) {
                        console.error("Error al iniciar sesión:", error.code);
                        if (error.code === 'auth/invalid-credential') {
                            showLoginMessage('Credenciales inválidas. Por favor, verifica el correo y la contraseña.', true);
                        } else if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                             showLoginMessage('Credenciales incorrectas.', true);
                        } else {
                            showLoginMessage('Error desconocido. Por favor, inténtalo de nuevo más tarde.', true);
                        }
                    }
                });
            }

            // Listener de autenticación para verificar el rol del usuario
            onAuthStateChanged(auth, async (user) => {
                console.log("Estado de autenticación cambiado:", user ? "Usuario autenticado" : "No hay usuario");
                if (user) {
                    try {
                        const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists() && userDocSnap.data().role === 'general_admin') {
                            loginContainer.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            deniedContainer.classList.add('hidden');
                        } else {
                            loginContainer.classList.add('hidden');
                            appContainer.classList.add('hidden');
                            deniedContainer.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error al obtener el rol del usuario:", error);
                        loginContainer.classList.add('hidden');
                        appContainer.classList.add('hidden');
                        deniedContainer.classList.remove('hidden');
                    }
                } else {
                    loginContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    deniedContainer.classList.add('hidden');
                }
            });

            // Función para mostrar mensajes en la interfaz de creación de admin
            function showMessage(msg, isError = false) {
                messageElement.textContent = msg;
                messageElement.className = `mt-4 text-sm font-semibold ${isError ? 'text-red-600' : 'text-green-600'}`;
            }
            
            const form = document.getElementById('create-admin-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const regionSelect = document.getElementById('region-select');

            // Manejar el envío del formulario
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    const region = regionSelect.value;
                    
                    if (!auth.currentUser) {
                        showMessage('Error: El usuario no está autenticado.', true);
                        return;
                    }

                    const userId = auth.currentUser.uid;

                    showMessage('Creando administrador...', false);

                    try {
                        // Usaremos el email como ID del documento para que la referencia sea única y fácil de encontrar.
                        const newUserDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', email);
                        await setDoc(newUserDocRef, {
                            email: email,
                            role: 'regional_admin',
                            region: region,
                            creatorId: userId,
                            createdAt: new Date()
                        });

                        showMessage('¡Administrador regional creado con éxito!', false);
                        form.reset();
                    } catch (error) {
                        console.error("Error al crear el administrador regional:", error);
                        showMessage('Error al crear el administrador. Por favor, inténtalo de nuevo.', true);
                    }
                });
            }
            
            // Autenticar con el token inicial si está disponible
            async function authenticateUserWithToken() {
                 if (initialAuthToken) {
                     try {
                         await signInWithCustomToken(auth, initialAuthToken);
                     } catch(error) {
                         console.error("Error al autenticar con el token inicial:", error);
                     }
                 }
            }
            authenticateUserWithToken();
        });
    </script>
</body>
</html>
