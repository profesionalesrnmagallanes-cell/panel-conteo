<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votación - Acceso Administrativo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de registro para depuración
        setLogLevel('debug');

        // Variables globales de Firebase, proporcionadas por el entorno.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializar Firebase
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase inicializado.");

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Usuario autenticado. ID:", userId);
                        } else {
                            userId = crypto.randomUUID();
                            console.log("Sesión anónima iniciada. ID:", userId);
                        }
                        isAuthReady = true;
                    });

                    // Autenticación con el token personalizado si está disponible.
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Autenticación con token personalizado exitosa.");
                        } catch (error) {
                            console.error("Error al autenticar con token personalizado:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                        console.log("Autenticación anónima exitosa.");
                    }
                } else {
                    console.error("Configuración de Firebase no encontrada.");
                    isAuthReady = true;
                }
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                isAuthReady = true;
            }
        });

        // Lógica de la aplicación
        window.addEventListener('load', () => {
            const loginForm = document.getElementById('login-form');
            const adminPinInput = document.getElementById('admin-pin');
            const loginView = document.getElementById('login-view');
            const adminView = document.getElementById('admin-view');
            const userView = document.getElementById('user-view');
            const userStatus = document.getElementById('user-status');
            const userVotacionesList = document.getElementById('user-votaciones-list');
            const adminVotacionesList = document.getElementById('admin-votaciones-list');
            const adminAddVotacionBtn = document.getElementById('admin-add-votacion');

            const VotacionesCollection = `artifacts/${appId}/public/data/votaciones`;

            function showView(viewName) {
                loginView.classList.add('hidden');
                adminView.classList.add('hidden');
                userView.classList.add('hidden');
                if (viewName === 'login') {
                    loginView.classList.remove('hidden');
                } else if (viewName === 'admin') {
                    adminView.classList.remove('hidden');
                } else if (viewName === 'user') {
                    userView.classList.remove('hidden');
                }
            }

            // Manejador del formulario de inicio de sesión
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const enteredPin = adminPinInput.value;
                const adminPin = '1234'; // PIN de administrador de prueba

                if (enteredPin === adminPin) {
                    showView('admin');
                    adminPinInput.value = '';
                    loadAdminData();
                } else {
                    showView('user');
                    adminPinInput.value = '';
                    loadUserData();
                }
            });

            // Lógica para el administrador
            async function loadAdminData() {
                if (!isAuthReady || !db) return;
                const q = query(collection(db, VotacionesCollection));
                onSnapshot(q, (querySnapshot) => {
                    adminVotacionesList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const votacion = doc.data();
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center bg-gray-100 p-3 mb-2 rounded-lg shadow-sm';
                        li.innerHTML = `
                            <span class="text-sm md:text-base">${votacion.titulo}</span>
                            <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-full text-xs transition duration-200" onclick="deleteVotacion('${doc.id}')">Eliminar</button>
                        `;
                        adminVotacionesList.appendChild(li);
                    });
                });
            }

            // Lógica para el usuario normal
            async function loadUserData() {
                if (!isAuthReady || !db) return;
                const q = query(collection(db, VotacionesCollection));
                onSnapshot(q, (querySnapshot) => {
                    userVotacionesList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const votacion = doc.data();
                        const li = document.createElement('li');
                        li.className = 'bg-gray-100 p-3 mb-2 rounded-lg shadow-sm text-sm md:text-base';
                        li.textContent = votacion.titulo;
                        userVotacionesList.appendChild(li);
                    });
                });
            }

            // Función para añadir una votación (solo para el admin)
            window.addVotacion = async () => {
                if (!isAuthReady || !db) return;
                const titulo = prompt("Escribe el título de la nueva votación:");
                if (titulo) {
                    try {
                        const docRef = await addDoc(collection(db, VotacionesCollection), { titulo: titulo, createdAt: new Date() });
                        console.log("Documento añadido con ID:", docRef.id);
                    } catch (e) {
                        console.error("Error al añadir documento:", e);
                    }
                }
            };

            // Función para eliminar una votación (solo para el admin)
            window.deleteVotacion = async (docId) => {
                // Lógica de eliminación, se puede implementar con deleteDoc
                alert(`Funcionalidad de eliminación para el documento con ID: ${docId}`);
            };
        });
    </script>
</head>
<body class="bg-gray-100 font-inter text-gray-800 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-xl mx-auto space-y-6">

        <!-- Vista de Inicio de Sesión -->
        <div id="login-view" class="bg-white p-8 rounded-2xl shadow-xl w-full">
            <h1 class="text-3xl font-bold text-center mb-6 text-gray-900">Bienvenido al Sistema de Votación</h1>
            <p class="text-center text-gray-600 mb-8">Por favor, ingresa tu PIN para continuar.</p>

            <form id="login-form">
                <div class="mb-6">
                    <label for="admin-pin" class="block text-gray-700 font-medium mb-2">PIN de Acceso</label>
                    <input type="password" id="admin-pin" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Ej. 1234" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition duration-200 shadow-md">
                    Acceder
                </button>
            </form>
        </div>

        <!-- Vista de Administrador -->
        <div id="admin-view" class="hidden bg-white p-8 rounded-2xl shadow-xl w-full">
            <h1 class="text-3xl font-bold text-center mb-6 text-green-700">Panel de Administrador</h1>
            <p class="text-center text-gray-600 mb-6">Gestiona las votaciones de tu aplicación. El ID de usuario actual es: <span class="font-mono text-xs md:text-sm bg-gray-200 p-1 rounded-md">{{userId}}</span></p>

            <button onclick="addVotacion()" id="admin-add-votacion" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold text-lg hover:bg-green-600 transition duration-200 shadow-md mb-6">
                Crear Nueva Votación
            </button>

            <h2 class="text-xl font-semibold mb-4 text-gray-800">Votaciones Creadas:</h2>
            <ul id="admin-votaciones-list">
                <!-- Las votaciones se cargarán aquí desde Firebase -->
            </ul>
        </div>

        <!-- Vista de Usuario (No Administrador) -->
        <div id="user-view" class="hidden bg-white p-8 rounded-2xl shadow-xl w-full">
            <h1 class="text-3xl font-bold text-center mb-6 text-gray-900">Vista de Usuario</h1>
            <p class="text-center text-gray-600 mb-6">Solo puedes ver las votaciones disponibles. El ID de usuario actual es: <span class="font-mono text-xs md:text-sm bg-gray-200 p-1 rounded-md">{{userId}}</span></p>

            <h2 class="text-xl font-semibold mb-4 text-gray-800">Votaciones Disponibles:</h2>
            <ul id="user-votaciones-list">
                <!-- Las votaciones se cargarán aquí desde Firebase -->
            </ul>
        </div>
    </main>
</body>
</html>